

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Electronics &mdash; PiCar Project 2018 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="PiCar Project 2018 documentation" href="../../index.html"/>
        <link rel="up" title="Usage" href="../usage.html"/>
        <link rel="next" title="Software" href="software.html"/>
        <link rel="prev" title="Mechanical" href="mechanical.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> PiCar Project
          

          
          </a>

          
            
            
              <div class="version">
                2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials.html">Tutorials</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../usage.html">Usage</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="mechanical.html">Mechanical</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Electronics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#first-thing-first-raspberry-pi-pinout">First thing First: Raspberry Pi Pinout</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pi-and-arduino-communication">Pi and Arduino Communication</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#i2c-method">I2C Method</a></li>
<li class="toctree-l4"><a class="reference internal" href="#spi-method">SPI Method</a></li>
<li class="toctree-l4"><a class="reference internal" href="#serial-method">Serial Method</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sending-more-than-one-byte-between-pi-and-arduino">Sending more than one byte between Pi and Arduino</a></li>
<li class="toctree-l4"><a class="reference internal" href="#i2c-by-gpio-general-purpose-input-output">I2C by GPIO(General-purpose input/output)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#pi-and-tfmini-lidar-communication">PI and TFMini Lidar Communication</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#setup">Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#wiring">Wiring</a></li>
<li class="toctree-l4"><a class="reference internal" href="#code">Code</a></li>
<li class="toctree-l4"><a class="reference internal" href="#use-gpio-pin-for-reading">Use GPIO pin for reading</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">Resources</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#pi-camera-usage">Pi Camera Usage</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#connection">Connection</a></li>
<li class="toctree-l4"><a class="reference internal" href="#capture-an-image">Capture an image</a></li>
<li class="toctree-l4"><a class="reference internal" href="#record-a-video-for-10-seconds">Record a video for 10 seconds</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">Resources</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#pi-and-imu-communication">PI and IMU communication</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#i2c-method-by-lsm9ds1-library">I2C Method by LSM9DS1 Library</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">Resources</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">I2C Method</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">Resources</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="software.html">Software</a></li>
<li class="toctree-l2"><a class="reference internal" href="datasheet.html">Datasheet</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../results.html">Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelogs.html">Changelogs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributors.html">Contributors</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">PiCar Project</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../usage.html">Usage</a> &raquo;</li>
      
    <li>Electronics</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/chapters/usage/electronics.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="electronics">
<h1>Electronics<a class="headerlink" href="#electronics" title="Permalink to this headline">¶</a></h1>
<p>The electronics section will deal with interfacing the Raspberry Pi and Arduino
with the sensors and actuators.</p>
<div class="section" id="first-thing-first-raspberry-pi-pinout">
<h2>First thing First: Raspberry Pi Pinout<a class="headerlink" href="#first-thing-first-raspberry-pi-pinout" title="Permalink to this headline">¶</a></h2>
<a class="reference internal image-reference" href="../../_images/j8header-3b.png"><img alt="../../_images/j8header-3b.png" src="../../_images/j8header-3b.png" style="width: 275px; height: 500px;" /></a>
</div>
<div class="section" id="pi-and-arduino-communication">
<h2>Pi and Arduino Communication<a class="headerlink" href="#pi-and-arduino-communication" title="Permalink to this headline">¶</a></h2>
<div class="section" id="i2c-method">
<h3>I2C Method<a class="headerlink" href="#i2c-method" title="Permalink to this headline">¶</a></h3>
<p>The code is from <a class="reference external" href="https://oscarliang.com/raspberry-pi-arduino-connected-i2c/">here</a>,
with slight changes to accommodate Python 3 instead of Python 2.</p>
<p><strong>Wiring</strong></p>
<table border="1" class="docutils">
<colgroup>
<col width="37%" />
<col width="63%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Rasberry Pi 3</th>
<th class="head">arduino Uno</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>GND</td>
<td>GND</td>
</tr>
<tr class="row-odd"><td>SDA (pin3)</td>
<td>SDA (The pin above AREF)</td>
</tr>
<tr class="row-even"><td>SCL (pin5)</td>
<td>SCL (The pin above SDA)</td>
</tr>
</tbody>
</table>
<p>And you can power arduino by usb on pi or on your labtop</p>
<a class="reference internal image-reference" href="../../_images/PiArduinoI2CHardware_bb.jpg"><img alt="../../_images/PiArduinoI2CHardware_bb.jpg" src="../../_images/PiArduinoI2CHardware_bb.jpg" style="width: 500px;" /></a>
<p><strong>Upload Arduino code to Arduino board</strong></p>
<p>The testing code is:</p>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;Wire.h&gt;</span><span class="cp"></span>
<span class="cp">#define SLAVE_ADDRESS 0x04</span>
<span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span> <span class="c1">// start serial for output</span>

  <span class="c1">// initialize i2c as slave</span>
  <span class="n">Wire</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">SLAVE_ADDRESS</span><span class="p">);</span>

  <span class="c1">// define callbacks for i2c communication</span>
  <span class="n">Wire</span><span class="p">.</span><span class="n">onReceive</span><span class="p">(</span><span class="n">receiveData</span><span class="p">);</span>
  <span class="n">Wire</span><span class="p">.</span><span class="n">onRequest</span><span class="p">(</span><span class="n">sendData</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Ready!&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">delay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// callback for received data</span>
<span class="kt">void</span> <span class="nf">receiveData</span><span class="p">(</span><span class="kt">int</span> <span class="n">byteCount</span><span class="p">){</span>
  <span class="k">while</span><span class="p">(</span><span class="n">Wire</span><span class="p">.</span><span class="n">available</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">number</span> <span class="o">=</span> <span class="n">Wire</span><span class="p">.</span><span class="n">read</span><span class="p">();</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;data received: &quot;</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">number</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
        <span class="n">digitalWrite</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span> <span class="c1">// set the LED on</span>
        <span class="n">state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span><span class="p">{</span>
        <span class="n">digitalWrite</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span> <span class="c1">// set the LED off</span>
        <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// callback for sending data</span>
<span class="kt">void</span> <span class="nf">sendData</span><span class="p">(){</span>
  <span class="n">Wire</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">number</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>Run the python code on the Raspberry Pi</strong></p>
<p>The testing code is:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">smbus</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="c1"># for RPI version 1, use  ^ ^ bus = smbus.SMBus(0) ^ ^</span>
<span class="n">bus</span> <span class="o">=</span> <span class="n">smbus</span><span class="o">.</span><span class="n">SMBus</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># This is the address we setup in the Arduino Program</span>
<span class="n">address</span> <span class="o">=</span> <span class="mh">0x04</span>

<span class="k">def</span> <span class="nf">writeNumber</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
  <span class="n">bus</span><span class="o">.</span><span class="n">write_byte</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
  <span class="c1"># bus.write_byte_data(address, 0, value)</span>
  <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

<span class="k">def</span> <span class="nf">readNumber</span><span class="p">():</span>
  <span class="n">number</span> <span class="o">=</span> <span class="n">bus</span><span class="o">.</span><span class="n">read_byte</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
  <span class="c1"># number = bus.read_byte_data(address, 1)</span>
  <span class="k">return</span> <span class="n">number</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
  <span class="n">var</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter 1  ^ ^  9: &quot;</span><span class="p">))</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">var</span><span class="p">:</span>
      <span class="k">continue</span>

  <span class="n">writeNumber</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
  <span class="k">print</span><span class="p">(</span><span class="s2">&quot;RPI: Hi Arduino, I sent you &quot;</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
  <span class="c1"># sleep one second</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

  <span class="n">number</span> <span class="o">=</span> <span class="n">readNumber</span><span class="p">()</span>
  <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Arduino: Hey RPI, I received a digit &quot;</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>
  <span class="k">print</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="see-also">
<h4>See Also:<a class="headerlink" href="#see-also" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference external" href="https://pypi.org/project/smbus-cffi/">SMBus Package</a></li>
</ul>
</div>
</div>
<div class="section" id="spi-method">
<h3>SPI Method<a class="headerlink" href="#spi-method" title="Permalink to this headline">¶</a></h3>
<p><strong>Wiring</strong></p>
<table border="1" class="docutils">
<colgroup>
<col width="52%" />
<col width="48%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Rasberry Pi 3</th>
<th class="head">arduino Uno</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>GND</td>
<td>GND</td>
</tr>
<tr class="row-odd"><td>MOSI (Pin19)</td>
<td>MOSI (Pin11)</td>
</tr>
<tr class="row-even"><td>MISO (Pin21)</td>
<td>MISO (Pin12)</td>
</tr>
<tr class="row-odd"><td>SCLK (Pin23)</td>
<td>SCLK (Pin13)</td>
</tr>
<tr class="row-even"><td>cell0 (Pin24)</td>
<td>SS (Pin10)</td>
</tr>
</tbody>
</table>
<p>and you can choose to power the arduino using USB cable on Pi
or on your laptop.</p>
<p><strong>SPI on arduino</strong></p>
<p>First the MISO pin has to be defined as an output pin.
All other pins are configured automatically as input pins if the SPI is enabled:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">pinMode</span><span class="p">(</span><span class="n">MISO</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
</pre></div>
</div>
<p>Second the SPI enable bit needs to be set:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">SPCR</span> <span class="o">|=</span> <span class="n">_BV</span><span class="p">(</span><span class="n">SPE</span><span class="p">);</span>
</pre></div>
</div>
<p>Reading and writing of SPI data is performed through SPDR. Programmatically you can treat SPDR as you would a variable. To read the contents of SDPR, it can either be accessed directly,
or another variable can be set equal to it:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">i</span> <span class="o">=</span> <span class="n">SPDR</span><span class="p">;</span>
</pre></div>
</div>
<p>To load the data register with a value to transmit back to the master, the statement is reversed:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">SPDR</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</pre></div>
</div>
<p>At the hardware level SPDR includes both an 8-bit shift register and an 8-bit receive buffer.
When the slave is receiving data, that data is shifted into the shift register one bit at a time while the original 8-bits in the register are shifted back to the master.
When a complete byte has been shifted into the register, that byte is then copied into the receive buffer. The receive buffer won’t be updated again until the next complete byte is received.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This means if the pi(master) wants to read from arduino(slave), it has to send something first !!</p>
</div>
<p><strong>Code:</strong></p>
<p>code on arduino</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*************************************************************</span>
<span class="cm"> SPI_Hello_Raspi</span>
<span class="cm">   Configures Arduino as an SPI slave and demonstrates</span>
<span class="cm">   bidirectional communication with an Raspberry Pi SPI master</span>
<span class="cm">****************************************************************/</span>

<span class="cp">#include</span> <span class="cpf">&lt;SPI.h&gt;</span><span class="cp"></span>

<span class="n">byte</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/***************************************************************</span>
<span class="cm"> Setup SPI in slave mode (1) define MISO pin as output (2) set</span>
<span class="cm"> enable bit of the SPI configuration register</span>
<span class="cm">****************************************************************/</span>

<span class="kt">void</span> <span class="nf">setup</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">MISO</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
  <span class="n">SPCR</span> <span class="o">|=</span> <span class="n">_BV</span><span class="p">(</span><span class="n">SPE</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/***************************************************************</span>
<span class="cm"> Loop until the SPI End of Transmission Flag (SPIF) is set</span>
<span class="cm"> indicating a byte has been received.  When a byte is</span>
<span class="cm"> received, load the byte,print it, and put 0x08 into SPDR for pi</span>
<span class="cm"> to read</span>
<span class="cm">****************************************************************/</span>

<span class="kt">void</span> <span class="nf">loop</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>

  <span class="k">if</span><span class="p">((</span><span class="n">SPSR</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SPIF</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">//arduino should receive 3 and 4</span>
    <span class="c1">//and send 8 to pi</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">SPDR</span><span class="p">;</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;we received: &quot;</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
    <span class="n">SPDR</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Python code on Pi(make sure you have pigpio installed and running by sudo pigpiod):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">time</span><span class="o">,</span><span class="nn">pigpio</span>


<span class="c1">#open spi</span>
<span class="n">pi</span> <span class="o">=</span> <span class="n">pigpio</span><span class="o">.</span><span class="n">pi</span><span class="p">()</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">pi</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
   <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">h</span> <span class="o">=</span> <span class="n">pi</span><span class="o">.</span><span class="n">spi_open</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">40000</span><span class="p">)</span>


<span class="c1">#function for communicating with arduino</span>
<span class="k">def</span> <span class="nf">communicate</span><span class="p">():</span>
   <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
      <span class="c1">#first send byts to arduino</span>
      <span class="n">pi</span><span class="o">.</span><span class="n">spi_write</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x03\x04</span><span class="s1">&#39;</span><span class="p">)</span>

      <span class="c1">#sleep 1 second and read 1 byte</span>
      <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="c1">#pi shoudl receive 0x08, which is sent from arduino</span>
      <span class="c1">#spi_read returns a tuple, first is the number of bytes read,</span>
      <span class="c1">#second is the byte array contains the bytes</span>
      <span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="n">data</span><span class="p">)</span> <span class="o">=</span> <span class="n">pi</span><span class="o">.</span><span class="n">spi_read</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
      <span class="c1">#at the same time for reading, arduino will receive 1 byte, which is 0x00</span>
      <span class="c1">#Why? remember in order to read, the pi has to send something to the arduino first !</span>
      <span class="c1">#By default, it will write 0 to arduino in order to read.</span>
      <span class="k">print</span><span class="p">(</span><span class="s2">&quot;we get </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">data</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
   <span class="k">try</span><span class="p">:</span>
      <span class="n">communicate</span><span class="p">()</span>
   <span class="k">except</span><span class="p">:</span>
      <span class="n">pi</span><span class="o">.</span><span class="n">spi_close</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
      <span class="n">pi</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>
<p>The arduino should continueously print 3,4 and 0 (for pi reading purpose) and
pi should receive and print 0x08.</p>
<div class="section" id="resources">
<h4>Resources<a class="headerlink" href="#resources" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference external" href="http://robotics.hobbizine.com/raspiduino.html">Pi_Arduino_SPI_communication</a></li>
</ul>
</div>
</div>
<div class="section" id="serial-method">
<h3>Serial Method<a class="headerlink" href="#serial-method" title="Permalink to this headline">¶</a></h3>
<p><strong>Wiring</strong></p>
<p>Connect arduino USB port to one of the USB port on raspberry pi</p>
<p><strong>Code</strong></p>
<p>The code is under <code class="docutils literal notranslate"><span class="pre">PiCar/src/Pi_Arduino_Communication/serial</span></code></p>
<p>On python side, it will continuously ask you to input a float, send it to arduino.</p>
<p>On arduino side, once the float is sent, it will recive the data and then send it back to pi.</p>
<p><strong>Difference compared with I2C and SPI</strong></p>
<p>As Serial communication is well studied, we are able to send and read block of bytes on pi side.</p>
<p>As a result, it is much more convenient to send data more than 1 byte (discussed in next section).</p>
</div>
<div class="section" id="sending-more-than-one-byte-between-pi-and-arduino">
<h3>Sending more than one byte between Pi and Arduino<a class="headerlink" href="#sending-more-than-one-byte-between-pi-and-arduino" title="Permalink to this headline">¶</a></h3>
<p><strong>Reason</strong></p>
<p>The above basic communication (i2c,spi) allows us to send one byte between pi and arduino.
However, if we want to send data that is more than one byte, such as float,
the above method does not work.
We first thought this is a well developed problem, and there should be easy function
being called to send block of data. However, the truth is that as far as we searched,
none of the proposed solution works.
We come out this example for sending float between pi and arduino. If you want to develop
data other than float, you are welcomed to do so.</p>
<p><strong>Wiring</strong></p>
<p>Same as I2C section or SPI section did</p>
<p><strong>Code</strong></p>
<p>The code for this is under <code class="docutils literal notranslate"><span class="pre">PiCar/src/Pi_Arduino_Communication</span></code>
each subfolder(i2c,spi,serial) contains two files, .ino file should run on arduino, and
.py file should run on raspberry pi.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The key for communication is to write a simple protocol, and split a float into 4 bytes, so we can send 1 byte each time.</p>
</div>
</div>
<div class="section" id="i2c-by-gpio-general-purpose-input-output">
<h3>I2C by GPIO(General-purpose input/output)<a class="headerlink" href="#i2c-by-gpio-general-purpose-input-output" title="Permalink to this headline">¶</a></h3>
<p><strong>Reason</strong></p>
<p>Sometimes, we may want to save I2C pin to other device, or we may want to connect multiple
arduino to raspberry pi. In this sections, we will use GPIO pins to connect our arduino by i2c.</p>
<p><strong>Wiring</strong></p>
<table border="1" class="docutils">
<colgroup>
<col width="38%" />
<col width="62%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Rasberry Pi 3</th>
<th class="head">arduino Uno</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>GND</td>
<td>GND</td>
</tr>
<tr class="row-odd"><td>Pin19</td>
<td>SDA(The pin above AREF)</td>
</tr>
<tr class="row-even"><td>Pin13</td>
<td>SCL(The pin above SDA)</td>
</tr>
</tbody>
</table>
<p>And you can power Arduino in whatever way you want.</p>
<p><strong>Code</strong></p>
<p>The arduino code is the same as above (I2C section)</p>
<p>The following is the code on Pi, make sure you have pigpio installed and running.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pigpio</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">pi</span> <span class="o">=</span> <span class="n">pigpio</span><span class="o">.</span><span class="n">pi</span><span class="p">()</span>
<span class="n">address</span> <span class="o">=</span> <span class="mh">0x04</span>

<span class="n">SDA</span> <span class="o">=</span> <span class="mi">19</span>
<span class="n">SCL</span> <span class="o">=</span> <span class="mi">13</span>


<span class="k">def</span> <span class="nf">communication</span><span class="p">():</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">pi</span><span class="o">.</span><span class="n">bb_i2c_open</span><span class="p">(</span><span class="n">SDA</span><span class="p">,</span><span class="n">SCL</span><span class="p">,</span><span class="mi">9600</span><span class="p">)</span>
        <span class="n">var</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter 1  ^ ^  9: &quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">var</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">pi</span><span class="o">.</span><span class="n">bb_i2c_zip</span><span class="p">(</span><span class="n">SDA</span><span class="p">,[</span><span class="mi">4</span><span class="p">,</span><span class="n">address</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x07</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="mh">0x03</span><span class="p">,</span><span class="mh">0x00</span><span class="p">])</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;RPI: Hi Arduino, I sent you &quot;</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">number</span> <span class="o">=</span> <span class="n">pi</span><span class="o">.</span><span class="n">bb_i2c_zip</span><span class="p">(</span><span class="n">SDA</span><span class="p">,[</span><span class="mi">4</span><span class="p">,</span><span class="n">address</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x06</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x03</span><span class="p">,</span><span class="mh">0x00</span><span class="p">])</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Arduino: Hey RPI, I received a digit &quot;</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>
        <span class="k">print</span><span class="p">()</span>

        <span class="n">pi</span><span class="o">.</span><span class="n">bb_i2c_close</span><span class="p">(</span><span class="n">SDA</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">communication</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">pi</span><span class="o">.</span><span class="n">bb_i2c_close</span><span class="p">(</span><span class="n">SDA</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="id1">
<h4>Resources<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference external" href="http://abyz.me.uk/rpi/pigpio/python.html">pigpio documentation</a></li>
</ul>
</div>
</div>
</div>
<div class="section" id="pi-and-tfmini-lidar-communication">
<h2>PI and TFMini Lidar Communication<a class="headerlink" href="#pi-and-tfmini-lidar-communication" title="Permalink to this headline">¶</a></h2>
<div class="section" id="setup">
<h3>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h3>
<p>To search for available serial ports, enter the following command in terminal:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>dmesg <span class="p">|</span> grep tty
</pre></div>
</div>
<p>If the output looks like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pi@raspberrypi:~ $ dmesg <span class="p">|</span> grep tty
<span class="o">[</span>    0.000000<span class="o">]</span> Kernel <span class="nb">command</span> line: <span class="m">8250</span>.nr_uarts<span class="o">=</span><span class="m">1</span> bcm2708_fb.fbwidth<span class="o">=</span><span class="m">1824</span> bcm2708_fb.fbheight<span class="o">=</span><span class="m">984</span> bcm2708_fb.fbswap<span class="o">=</span><span class="m">1</span> dma.dmachans<span class="o">=</span>0x7f35
bcm2709.boardrev<span class="o">=</span>0xa02082 bcm2709.serial<span class="o">=</span>0x11f38c9c bcm2709.uart_clock<span class="o">=</span><span class="m">48000000</span> smsc95xx.macaddr<span class="o">=</span>B8:27:EB:F3:8C:9C vc_mem.mem_base<span class="o">=</span>0x3dc00000
vc_mem.mem_size<span class="o">=</span>0x3f000000  dwc_otg.lpm_enable<span class="o">=</span><span class="m">0</span> <span class="nv">console</span><span class="o">=</span>tty1 <span class="nv">console</span><span class="o">=</span>ttyS0,115200 <span class="nv">root</span><span class="o">=</span>/dev/mmcblk0p7 <span class="nv">rootfstype</span><span class="o">=</span>ext4 <span class="nv">elevator</span><span class="o">=</span>deadline
fsck.repair<span class="o">=</span>yes rootwait splash plymouth.ignore-serial-consoles
<span class="o">[</span>    0.001365<span class="o">]</span> console <span class="o">[</span>tty1<span class="o">]</span> enabled
<span class="o">[</span>    0.343313<span class="o">]</span> console <span class="o">[</span>ttyS0<span class="o">]</span> disabled
<span class="o">[</span>    0.343481<span class="o">]</span> 3f215040.uart: ttyS0 at MMIO 0x3f215040 <span class="o">(</span><span class="nv">irq</span> <span class="o">=</span> <span class="m">59</span>, <span class="nv">base_baud</span> <span class="o">=</span> <span class="m">31250000</span><span class="o">)</span> is a <span class="m">16550</span>
<span class="o">[</span>    1.078177<span class="o">]</span> console <span class="o">[</span>ttyS0<span class="o">]</span> enabled
<span class="o">[</span>    2.210431<span class="o">]</span> 3f201000.uart: ttyAMA0 at MMIO 0x3f201000 <span class="o">(</span><span class="nv">irq</span> <span class="o">=</span> <span class="m">87</span>, <span class="nv">base_baud</span> <span class="o">=</span> <span class="m">0</span><span class="o">)</span> is a PL011 rev2
<span class="o">[</span>    3.527349<span class="o">]</span> systemd<span class="o">[</span><span class="m">1</span><span class="o">]</span>: Expecting device dev-ttyS0.device...
<span class="o">[</span>    4.653975<span class="o">]</span> systemd<span class="o">[</span><span class="m">1</span><span class="o">]</span>: Starting system-serial<span class="se">\x</span>2dgetty.slice.
<span class="o">[</span>    4.669517<span class="o">]</span> systemd<span class="o">[</span><span class="m">1</span><span class="o">]</span>: Created slice system-serial<span class="se">\x</span>2dgetty.slice.
</pre></div>
</div>
<p>The console needs to be disabled on the serial port <code class="docutils literal notranslate"><span class="pre">ttyAMA0</span></code>.</p>
<p>To do so, run the configuration command</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo raspi-config
</pre></div>
</div>
<p>and navigate to option 5, Interfacing Options. Choose P6, Serial.</p>
<p>When prompted, answer No to “Would you like a login shell to be accessible over serial?” and Yes to “Would you like the seria port hardware to be enabled?”.</p>
<p>Enter the following command to reboot and search for available ports again:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo reboot
dmesg <span class="p">|</span> grep tty
</pre></div>
</div>
<p>The output now should look like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pi@raspberrypi:~ $ dmesg <span class="p">|</span> grep tty
<span class="o">[</span>    0.000000<span class="o">]</span> Kernel <span class="nb">command</span> line: <span class="m">8250</span>.nr_uarts<span class="o">=</span><span class="m">1</span> bcm2708_fb.fbwidth<span class="o">=</span><span class="m">1824</span> bcm2708_fb.fbheight<span class="o">=</span><span class="m">984</span> bcm2708_fb.fbswap<span class="o">=</span><span class="m">1</span>
dma.dmachans<span class="o">=</span>0x7f35 bcm2709.boardrev<span class="o">=</span>0xa02082 bcm2709.serial<span class="o">=</span>0x11f38c9c bcm2709.uart_clock<span class="o">=</span><span class="m">48000000</span>
smsc95xx.macaddr<span class="o">=</span>B8:27:EB:F3:8C:9C vc_mem.mem_base<span class="o">=</span>0x3dc00000 vc_mem.mem_size<span class="o">=</span>0x3f000000  dwc_otg.lpm_enable<span class="o">=</span><span class="m">0</span>
<span class="nv">console</span><span class="o">=</span>tty1 <span class="nv">root</span><span class="o">=</span>/dev/mmcblk0p7 <span class="nv">rootfstype</span><span class="o">=</span>ext4 <span class="nv">elevator</span><span class="o">=</span>deadline fsck.repair<span class="o">=</span>yes rootwait splash plymouth.ignore-serial-consoles
<span class="o">[</span>    0.001345<span class="o">]</span> console <span class="o">[</span>tty1<span class="o">]</span> enabled
<span class="o">[</span>    0.343464<span class="o">]</span> 3f215040.uart: ttyS0 at MMIO 0x3f215040 <span class="o">(</span><span class="nv">irq</span> <span class="o">=</span> <span class="m">59</span>, <span class="nv">base_baud</span> <span class="o">=</span> <span class="m">31250000</span><span class="o">)</span> is a <span class="m">16550</span>
<span class="o">[</span>    1.146776<span class="o">]</span> 3f201000.uart: ttyAMA0 at MMIO 0x3f201000 <span class="o">(</span><span class="nv">irq</span> <span class="o">=</span> <span class="m">87</span>, <span class="nv">base_baud</span> <span class="o">=</span> <span class="m">0</span><span class="o">)</span> is a PL011 rev2
</pre></div>
</div>
</div>
<div class="section" id="wiring">
<h3>Wiring<a class="headerlink" href="#wiring" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="56%" />
<col width="44%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Rasberry Pi 3</th>
<th class="head">TFmini</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>+5V</td>
<td>5V (RED)</td>
</tr>
<tr class="row-odd"><td>GND</td>
<td>GND (BLACK)</td>
</tr>
<tr class="row-even"><td>TXD0 (pin8)</td>
<td>RX (WHITE)</td>
</tr>
<tr class="row-odd"><td>RXD0 (pin10)</td>
<td>TX (GREEN)</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">the white wire on TFmini Lidar is used to write command to it. If we just want to read from it, we can leave the white wire not connected.</p>
</div>
</div>
<div class="section" id="code">
<h3>Code<a class="headerlink" href="#code" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># tfmini.py</span>
<span class="c1"># supports Python 2</span>
<span class="c1"># prints distance from sensor</span>

<span class="c1">#coding: utf-8</span>
<span class="kn">import</span> <span class="nn">serial</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="n">ser</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span><span class="s2">&quot;/dev/ttyS0&quot;</span><span class="p">,</span> <span class="mi">115200</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">getTFminiData</span><span class="p">():</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">in_waiting</span>
    <span class="c1">#count = 0</span>
    <span class="c1">#print(count)</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">recv</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
        <span class="n">ser</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">recv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span> <span class="ow">and</span> <span class="n">recv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="c1"># 0x59 is &#39;Y&#39;</span>
            <span class="n">low</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">recv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
            <span class="n">high</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">recv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
            <span class="n">distance</span> <span class="o">=</span> <span class="n">low</span> <span class="o">+</span> <span class="n">high</span> <span class="o">*</span> <span class="mi">256</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;distance is: &#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ser</span><span class="o">.</span><span class="n">is_open</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">ser</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
            <span class="n">getTFminiData</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>   <span class="c1"># Ctrl+C</span>
        <span class="k">if</span> <span class="n">ser</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># tfmini_2.py</span>
<span class="c1"># supports Python 2 or Python 3</span>
<span class="c1"># prints distance and strength from sensor</span>

<span class="c1">#coding: utf-8</span>
<span class="kn">import</span> <span class="nn">serial</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">ser</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span><span class="s2">&quot;/dev/ttyS0&quot;</span><span class="p">,</span> <span class="mi">115200</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">getTFminiData</span><span class="p">():</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="c1">#time.sleep(0.1)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">in_waiting</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">recv</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
            <span class="n">ser</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span>
            <span class="c1"># type(recv), &#39;str&#39; in python2(recv[0] = &#39;Y&#39;), &#39;bytes&#39; in python3(recv[0] = 89)</span>
            <span class="c1"># type(recv[0]), &#39;str&#39; in python2, &#39;int&#39; in python3</span>

            <span class="k">if</span> <span class="n">recv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x59</span> <span class="ow">and</span> <span class="n">recv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x59</span><span class="p">:</span>     <span class="c1">#python3</span>
                <span class="n">distance</span> <span class="o">=</span> <span class="n">recv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">recv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span>
                <span class="n">strength</span> <span class="o">=</span> <span class="n">recv</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">recv</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">strength</span><span class="p">,</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
                <span class="n">ser</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">recv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span> <span class="ow">and</span> <span class="n">recv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span>     <span class="c1">#python2</span>
                <span class="n">lowD</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">recv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
                <span class="n">highD</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">recv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
                <span class="n">lowS</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">recv</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
                <span class="n">highS</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">recv</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
                <span class="n">distance</span> <span class="o">=</span> <span class="n">lowD</span> <span class="o">+</span> <span class="n">highD</span> <span class="o">*</span> <span class="mi">256</span>
                <span class="n">strength</span> <span class="o">=</span> <span class="n">lowS</span> <span class="o">+</span> <span class="n">highS</span> <span class="o">*</span> <span class="mi">256</span>
                <span class="k">print</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">strength</span><span class="p">)</span>

            <span class="c1"># you can also distinguish python2 and python3:</span>
            <span class="c1">#import sys</span>
            <span class="c1">#sys.version[0] == &#39;2&#39;    #True, python2</span>
            <span class="c1">#sys.version[0] == &#39;3&#39;    #True, python3</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ser</span><span class="o">.</span><span class="n">is_open</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">ser</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
        <span class="n">getTFminiData</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>   <span class="c1"># Ctrl+C</span>
        <span class="k">if</span> <span class="n">ser</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="use-gpio-pin-for-reading">
<h3>Use GPIO pin for reading<a class="headerlink" href="#use-gpio-pin-for-reading" title="Permalink to this headline">¶</a></h3>
<p>If we connect TX (green wire on TFmini Lidar) to the GPIO pin23, we can use it as a simulative port and read from it.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*</span>
<span class="kn">import</span> <span class="nn">pigpio</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">RX</span> <span class="o">=</span> <span class="mi">23</span>

<span class="n">pi</span> <span class="o">=</span> <span class="n">pigpio</span><span class="o">.</span><span class="n">pi</span><span class="p">()</span>
<span class="n">pi</span><span class="o">.</span><span class="n">set_mode</span><span class="p">(</span><span class="n">RX</span><span class="p">,</span> <span class="n">pigpio</span><span class="o">.</span><span class="n">INPUT</span><span class="p">)</span>
<span class="n">pi</span><span class="o">.</span><span class="n">bb_serial_read_open</span><span class="p">(</span><span class="n">RX</span><span class="p">,</span> <span class="mi">115200</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">getTFminiData</span><span class="p">():</span>
  <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="c1">#print(&quot;#############&quot;)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>  <span class="c1">#change the value if needed</span>
    <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">recv</span><span class="p">)</span> <span class="o">=</span> <span class="n">pi</span><span class="o">.</span><span class="n">bb_serial_read</span><span class="p">(</span><span class="n">RX</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">count</span><span class="o">-</span><span class="mi">9</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">recv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">89</span> <span class="ow">and</span> <span class="n">recv</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">89</span><span class="p">:</span> <span class="c1"># 0x59 is 89</span>
          <span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span>
          <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
            <span class="n">checksum</span> <span class="o">=</span> <span class="n">checksum</span> <span class="o">+</span> <span class="n">recv</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]</span>
          <span class="n">checksum</span> <span class="o">=</span> <span class="n">checksum</span> <span class="o">%</span> <span class="mi">256</span>
          <span class="k">if</span> <span class="n">checksum</span> <span class="o">==</span> <span class="n">recv</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">]:</span>
            <span class="n">distance</span> <span class="o">=</span> <span class="n">recv</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">recv</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span>
            <span class="n">strength</span> <span class="o">=</span> <span class="n">recv</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">recv</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span>
            <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;=</span> <span class="mi">1200</span> <span class="ow">and</span> <span class="n">strength</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">:</span>
              <span class="k">print</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">strength</span><span class="p">)</span>
            <span class="c1">#else:</span>
              <span class="c1"># raise ValueError(&#39;distance error: %d&#39; % distance)</span>
            <span class="c1">#i = i + 9</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">getTFminiData</span><span class="p">()</span>
  <span class="k">except</span><span class="p">:</span>
    <span class="n">pi</span><span class="o">.</span><span class="n">bb_serial_read_close</span><span class="p">(</span><span class="n">RX</span><span class="p">)</span>
    <span class="n">pi</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>
<p>In this way, we can save the TX port for other device, or connect multiple lidars to raspberry pi</p>
</div>
<div class="section" id="id2">
<h3>Resources<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="http://www.instructables.com/id/Read-and-write-from-serial-port-with-Raspberry-Pi/">Read and write from serial port with Raspberry Pi</a></li>
<li><a class="reference external" href="https://github.com/TFmini/TFmini-RaspberryPi">TFmini-RaspberryPi</a></li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="pi-camera-usage">
<h2>Pi Camera Usage<a class="headerlink" href="#pi-camera-usage" title="Permalink to this headline">¶</a></h2>
<div class="section" id="connection">
<h3>Connection<a class="headerlink" href="#connection" title="Permalink to this headline">¶</a></h3>
<p>Install the Raspberry Pi Camera module by inserting the cable into the Raspberry Pi.
The cable slots into the connector situated between the Ethernet and HDMI ports, with the silver connectors facing the HDMI port.</p>
</div>
<div class="section" id="capture-an-image">
<h3>Capture an image<a class="headerlink" href="#capture-an-image" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo raspistill -o image.jpg
</pre></div>
</div>
</div>
<div class="section" id="record-a-video-for-10-seconds">
<h3>Record a video for 10 seconds<a class="headerlink" href="#record-a-video-for-10-seconds" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo raspivid -o video.h264 -t <span class="m">10000</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h3>Resources<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="https://thepihut.com/blogs/raspberry-pi-tutorials/16021420-how-to-install-use-the-raspberry-pi-camera">How to install/use the pi camera</a></li>
<li><a class="reference external" href="http://picar.readthedocs.io/en/latest/chapters/usage/software.html">python code and rapid capturing</a></li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="pi-and-imu-communication">
<h2>PI and IMU communication<a class="headerlink" href="#pi-and-imu-communication" title="Permalink to this headline">¶</a></h2>
<div class="section" id="i2c-method-by-lsm9ds1-library">
<h3>I2C Method by LSM9DS1 Library<a class="headerlink" href="#i2c-method-by-lsm9ds1-library" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="id4">
<h3>Setup<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>In order to use the LSM9DS1 Library, we need to install WiringPi first.
Enter the following command in Pi terminal:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo apt-get install libi2c-dev
git clone git://git.drogon.net/wiringPi
<span class="nb">cd</span> wiringPi
git pull origin
./build
</pre></div>
</div>
<p>Then we can install the LSM9DS1 Library:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git clone https://github.com/akimach/LSM9DS1_RaspberryPi_Library.git
<span class="nb">cd</span> LSM9DS1_RaspberryPi_Library
make
sudo make install
</pre></div>
</div>
<p>To test it, we can run the python sample code inside the library once we connect the IMU:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> LSM9DS1_RaspberryPi_Library/example
sudo python LSM9DS1_Basic_I2C.py
</pre></div>
</div>
<p>Wiring</p>
<table border="1" class="docutils">
<colgroup>
<col width="59%" />
<col width="41%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">RPI</th>
<th class="head">IMU</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>3.3v (Pin1)</td>
<td>Vcc</td>
</tr>
<tr class="row-odd"><td>SDA (Pin3)</td>
<td>SDA</td>
</tr>
<tr class="row-even"><td>SCL (Pin5)</td>
<td>SCL</td>
</tr>
<tr class="row-odd"><td>GND (Pin6)</td>
<td>Gnd</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id5">
<h3>Resources<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference external" href="https://github.com/akimach/LSM9DS1_RaspberryPi_Library">LSM9DS1_RaspberryPi_Library</a></li>
</ul>
</div>
<div class="section" id="id6">
<h3>I2C Method<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>The example code for this section in the <code class="docutils literal notranslate"><span class="pre">PiCar/src/pi/imu</span></code>.</p>
<p>To compile, use the command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gcc -o &lt;programname&gt; runi2c.c -lm
</pre></div>
</div>
<p>Wiring:</p>
<p>same as above did</p>
<p>The connection is by SMBUS.</p>
<p>For RPI, go to <code class="docutils literal notranslate"><span class="pre">/usr/include/linux</span></code>, replace <code class="docutils literal notranslate"><span class="pre">i2c_dev.h</span></code> with the header file in the repository</p>
<p>(Method ‘enableIMU’ needs further development to enable IMU configuration setting)</p>
<div class="section" id="id7">
<h4>See Also:<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference external" href="https://cdn.sparkfun.com/assets/learn_tutorials/3/7/3/LSM9DS1_Datasheet.pdf/">IMU datasheet</a></li>
</ul>
</div>
</div>
<div class="section" id="id8">
<h3>Resources<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference external" href="https://learn.sparkfun.com/tutorials/i2c">I2C SPI Reference page</a></li>
</ul>
<p>Contributors: Jerry Kong, Shadi Davari, Josh Jin</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="software.html" class="btn btn-neutral float-right" title="Software" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="mechanical.html" class="btn btn-neutral" title="Mechanical" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, xz-group.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'2018',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>